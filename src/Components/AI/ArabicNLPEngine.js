// ูุญุฑู ูุนุงูุฌุฉ ุงููุบุฉ ุงูุนุฑุจูุฉ ุงูุทุจูุนูุฉ - ูููุฐุฌ AI ุฎููู ููุชุทูุฑ
class ArabicNLPEngine {
  constructor() {
    // ูููุฐุฌ ุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุฏุฑุจ ูุณุจูุงู
    this.arabicPatterns = {
      // ุฃููุงุท ุงูุชุญูุฉ ูุงูุชุฑุญูุจ
      greetings: {
        patterns: [
          /^(ูุฑุญุจุง|ูุฑุญุจุงู|ุงููุง|ุฃููุง|ุฃููุงู|ููุง|ูุงู|ูุงู|ุงูุณูุงู ุนูููู|ุตุจุงุญ ุงูุฎูุฑ|ูุณุงุก ุงูุฎูุฑ|ุณูุงู)/i,
          /^(ุงุฒูู|ูููู|ููู ุญุงูู|ุดู ุงุฎุจุงุฑู|ููู ุงูุญุงู)/i
        ],
        responses: [
          "ุฃููุงู ูุณููุงู ุจู! ๐ ููู ูููููู ูุณุงุนุฏุชู ุงููููุ",
          "ูุฑุญุจุงู ุจู ูู ูุชุฌุฑูุง! ๐ ุฃูุง ููุง ูุฃุณุงุนุฏู ูู ุฅูุฌุงุฏ ูุง ุชุจุญุซ ุนูู",
          "ุฃููุงู! ูุณุนุฏูู ุงูุชุญุฏุซ ูุนู ๐ ููู ุฃูุฏุฑ ุฃุณุงุนุฏูุ",
          "ูุนูููู ุงูุณูุงู! ุชุดุฑููุง ุจุฒูุงุฑุชู ๐ ุฅูุด ุชุญุชุงุฌุ"
        ]
      },

      // ุฃููุงุท ุงูุณุคุงู ุนู ุงูููุชุฌุงุช
      productQueries: {
        patterns: [
          /(ุฃุฑูุฏ|ุจุฏู|ุนุงูุฒ|ุนุงูุฒ|ุงุจุบู|ุงุจู|ูุญุชุงุฌ|ุจุญุงุฌุฉ).*(ููุชุฌ|ุณูุนุฉ|ุญุงุฌุฉ|ุดู|ุดูุก)/i,
          /(ุนูุฏูู|ุนูุฏู|ูู ุนูุฏูู|ููุฌูุฏ|ูุชููุฑ).*([\u0600-\u06FF]+)/i,
          /(ุงุจุญุซ ุนู|ุฏูุฑ ุนูู|ุจุฏูุฑ ุนูู|ููู|ููู|ุงูู).*([\u0600-\u06FF]+)/i
        ],
        responseTemplates: [
          "ุทุจุนุงู! ุนูุฏูุง {count} {product} ุฑุงุฆุนุ ุฎูููู ุฃูุฑูู ุฃูุถููุง:",
          "ุฃููุฏ! ูููุช ูู {count} ุฎูุงุฑ ูู {product}ุ ุดูู ูุฐูู:",
          "ุชูุงูุ ุนูุฏู {count} {product} ููุชุงุฒุ ุชูุถู ุดูููู:"
        ]
      },

      // ุฃููุงุท ุงูุฃุณุนุงุฑ ูุงูุนุฑูุถ
      priceQueries: {
        patterns: [
          /(ูู|ุจูู|ูู ุณุนุฑ|ุดู ุณุนุฑ|ุงูุด ุณุนุฑ|ูุฏูุด|ูุฏุงุด).*/i,
          /(ุฑุฎูุต|ุบุงูู|ููุงุณุจ|ูุนููู|ุนุฑุถ|ุฎุตู|ุชุฎููุถ).*/i,
          /(ุงุฑุฎุต|ุฃุฑุฎุต|ุงุบูู|ุฃุบูู|ุงุญุณู ุณุนุฑ|ุฃุญุณู ุณุนุฑ).*/i
        ],
        responses: [
          "ุนูุฏูุง ุนุฑูุถ ูููุฒุฉ ุฌุฏุงู! ุงูุฃุณุนุงุฑ ุชุจุฏุฃ ูู {minPrice}$ ููู ุฎุตููุงุช ุชุตู ูู {discount}%! ๐",
          "ุฃุณุนุงุฑูุง ููุงูุณุฉ ุฌุฏุงู! ูุนูุฏูุง ุนุฑูุถ ุฎุงุตุฉ ูุงูุฃุณุจูุน ๐ฐ",
          "ุจุงููุณุจุฉ ููุฃุณุนุงุฑุ ุนูุฏูุง ุชุดูููุฉ ูุงุณุนุฉ ุชูุงุณุจ ูู ุงูููุฒุงููุงุช ๐"
        ]
      },

      // ุฃููุงุท ุงูุดูุฑ ูุงููุฏุงุน
      farewell: {
        patterns: [
          /(ุดูุฑุง|ุดูุฑุงู|ูุดููุฑ|ุชุณูู|ูุนุทูู ุงูุนุงููุฉ|ุงููู ูุนุทูู ุงูุนุงููุฉ)/i,
          /(ุจุงู|ุจุงู|ูุฏุงุนุง|ูุฏุงุนุงู|ูุน ุงูุณูุงูุฉ|ุงูู ุงูููุงุก|ููุง ุณูุงู)/i
        ],
        responses: [
          "ุงูุนูู ุญุจูุจู! ูุงู ูู ุฏูุงุนู ุณุฑูุฑู ๐ ุชุนุงู ุฒูุฑูุง ูุฑุฉ ุซุงููุฉ!",
          "ุงููู ูุนุงููู! ููุฑุชูุง ูุงููู ๐ ุงุณุชูุงู ุงููุฑุฉ ุงูุฌุงูุฉ",
          "ุชุณูู! ููุช ุณุนูุฏ ุจุฎุฏูุชู ๐ ูุง ุชูุณุงูุงุด!",
          "ูุน ุงูุณูุงูุฉ! ูุง ุฑูุช ุชููู ูููุช ุงููู ุจุฏู ุฅูุงู ๐"
        ]
      }
    };

    // ูุงููุณ ุงููุดุงุนุฑ ูุงูุชุนุงุจูุฑ ุงูุจุดุฑูุฉ
    this.humanExpressions = {
      excitement: ["ูุงุงุงู! ๐คฉ", "ูุง ุณูุงู! ๐", "ุฑููุจ! ๐ฅ", "ุฎูุงุงุงู! โจ"],
      thinking: ["ุฎูููู ุฃุดูู... ๐ค", "ูุญุธุฉ ุจุณ... ๐ญ", "ููู... ๐ง", "ุทูุจ... ๐ค"],
      empathy: ["ุฃูููู ุชูุงูุงู", "ูุนู ุญู", "ุฃููุฏ", "ุตุญ ููุงูู"],
      encouragement: ["ูุง ุชููู!", "ุฎูููุง ุนูู!", "ุฑุงุญ ุฃุณุงุนุฏู!", "ุชูุงู ุงูุชูุงู!"]
    };

    // ุฐุงูุฑุฉ ุงููุญุงุฏุซุฉ ููุณูุงู
    this.conversationMemory = {
      userName: null,
      preferences: [],
      searchHistory: [],
      mood: 'neutral',
      interactionCount: 0
    };

    // ูููุฐุฌ ุชุญููู ุงููุดุงุนุฑ
    this.sentimentKeywords = {
      positive: ['ููุชุงุฒ', 'ุฑุงุฆุน', 'ุญูู', 'ุฌููู', 'ุนุธูู', 'ูุฐูู', 'ุฎูุงู', 'ุฑูุนุฉ'],
      negative: ['ุณูุก', 'ูุด ุญูู', 'ุบุงูู', 'ูุง ุจุฏู', 'ูุง', 'ูุด ุนุงุฌุจูู'],
      neutral: ['ุนุงุฏู', 'ูููู', 'ูููู', 'ุดูู', 'ุทูุจ']
    };
  }

  // ุชุญููู ุงููุดุงุนุฑ ูู ุงููุต
  analyzeSentiment(text) {
    let sentiment = 'neutral';
    let score = 0;

    this.sentimentKeywords.positive.forEach(word => {
      if (text.includes(word)) score += 1;
    });

    this.sentimentKeywords.negative.forEach(word => {
      if (text.includes(word)) score -= 1;
    });

    if (score > 0) sentiment = 'positive';
    else if (score < 0) sentiment = 'negative';

    return { sentiment, score };
  }

  // ุงุณุชุฎุฑุงุฌ ุงูููุงูุงุช (Entities) ูู ุงููุต
  extractEntities(text) {
    const entities = {
      products: [],
      brands: [],
      categories: [],
      prices: [],
      colors: []
    };

    // ุงุณุชุฎุฑุงุฌ ุงูุฃุณุนุงุฑ
    const pricePattern = /(\d+)\s*(ุฏููุงุฑ|ุฑูุงู|ุฌููู|ุฏููุงุฑ|\$)/gi;
    const priceMatches = text.matchAll(pricePattern);
    for (const match of priceMatches) {
      entities.prices.push(parseInt(match[1]));
    }

    // ุงุณุชุฎุฑุงุฌ ุงูุฃููุงู
    const colors = ['ุฃุญูุฑ', 'ุฃุฒุฑู', 'ุฃุฎุถุฑ', 'ุฃุณูุฏ', 'ุฃุจูุถ', 'ุฑูุงุฏู', 'ุฐูุจู', 'ูุถู'];
    colors.forEach(color => {
      if (text.includes(color)) {
        entities.colors.push(color);
      }
    });

    // ุงุณุชุฎุฑุงุฌ ุฃุณูุงุก ุงูููุชุฌุงุช ุงูุดุงุฆุนุฉ
    const commonProducts = ['ูุงุชู', 'ูุงุจุชูุจ', 'ุชุงุจูุช', 'ุณุงุนุฉ', 'ุณูุงุนุฉ', 'ูุงููุฑุง', 'ุชููุฒููู'];
    commonProducts.forEach(product => {
      if (text.includes(product)) {
        entities.products.push(product);
      }
    });

    return entities;
  }

  // ุชูููุฏ ุฑุฏ ุจุดุฑู ุทุจูุนู
  generateHumanResponse(intent, context = {}) {
    const { sentiment } = this.analyzeSentiment(context.userMessage || '');
    const entities = this.extractEntities(context.userMessage || '');
    
    let response = '';
    
    // ุฅุถุงูุฉ ุชุนุจูุฑ ุจุดุฑู ูู ุงูุจุฏุงูุฉ
    if (sentiment === 'positive') {
      response += this.getRandomElement(this.humanExpressions.excitement) + ' ';
    } else if (context.isThinking) {
      response += this.getRandomElement(this.humanExpressions.thinking) + ' ';
    }

    // ุจูุงุก ุงูุฑุฏ ุงูุฃุณุงุณู
    switch(intent) {
      case 'greeting':
        response += this.handleGreeting(context);
        break;
      
      case 'product_search':
        response += this.handleProductSearch(entities, context);
        break;
      
      case 'price_inquiry':
        response += this.handlePriceInquiry(entities, context);
        break;
      
      case 'recommendation':
        response += this.handleRecommendation(context);
        break;
      
      case 'farewell':
        response += this.handleFarewell(context);
        break;
      
      default:
        response += this.handleGeneral(context);
    }

    // ุฅุถุงูุฉ ููุณุฉ ุดุฎุตูุฉ
    if (this.conversationMemory.interactionCount > 2) {
      response += this.addPersonalTouch();
    }

    // ุชุญุฏูุซ ุงูุฐุงูุฑุฉ
    this.updateMemory(intent, entities, sentiment);

    return response;
  }

  // ูุนุงูุฌุฉ ุงูุชุญูุฉ
  handleGreeting(context) {
    const greetings = [
      "ุฃููุงู ูุณููุงู! ููู ุญุงูู ุงููููุ ๐",
      "ูุฑุญุจุงู! ุชุดุฑููุง ุจุฒูุงุฑุชูุ ููู ุฃูุฏุฑ ุฃุณุงุนุฏูุ",
      "ุฃููุงู ุจู! ุฃูุง ุฒุญูุ ูุณุงุนุฏู ุงูุดุฎุตู ูู ุงูุชุณูู ๐๏ธ",
      "ูุง ููุง ูุงููู! ููุฑุช ุงููุชุฌุฑุ ุฅูุด ุชุฏูุฑ ุนูููุ"
    ];
    
    let greeting = this.getRandomElement(greetings);
    
    // ุฅุถุงูุฉ ุชุญูุฉ ุดุฎุตูุฉ ุฅุฐุง ูุงู ุงูุนููู ุนุงุฆุฏ
    if (this.conversationMemory.interactionCount > 0) {
      greeting = "ุฃููุงู ุจุนูุฏุชู! ๐ ุดู ุงูุฌุฏูุฏ ูุนู ุงููููุ";
    }
    
    return greeting;
  }

  // ูุนุงูุฌุฉ ุงูุจุญุซ ุนู ุงูููุชุฌุงุช
  handleProductSearch(entities, context) {
    const { products } = context;
    
    if (!products || products.length === 0) {
      return "ููู... ูุง ูููุช ุงูุดู ุงููู ุจุชุฏูุฑ ุนููู ุจุงูุถุจุทุ ุจุณ ุฎูููู ุฃูุฑูู ุฃุญุฏุซ ุงูููุชุฌุงุช ุนูุฏูุง! ๐";
    }

    const responses = [
      `ูููุช ูู ${products.length} ููุชุฌ ุฑููุจ! ุชุนุงู ุดูููู: ๐`,
      `ุนูุฏู ${products.length} ุฎูุงุฑ ููุชุงุฒ ูู! ูููู ุญูููู ูุงููู: โจ`,
      `ูุงุงุงู! ูููุช ${products.length} ููุชุฌ ูุฌูู! ุดูู ูุฐูู: ๐ฅ`
    ];

    let response = this.getRandomElement(responses);
    
    // ุฅุถุงูุฉ ุชูุงุตูู ุนู ุงูููุชุฌุงุช
    if (entities.colors.length > 0) {
      response += `\nูููุงู ูุชููุฑูู ุจุงูููู ${entities.colors[0]} ุงููู ุจุชุญุจู!`;
    }
    
    if (entities.prices.length > 0) {
      response += `\nูุงูุฃุณุนุงุฑ ูู ุญุฏูุฏ ${entities.prices[0]}$ ุฒู ูุง ุทูุจุช ๐`;
    }

    return response;
  }

  // ูุนุงูุฌุฉ ุงูุงุณุชูุณุงุฑ ุนู ุงูุฃุณุนุงุฑ
  handlePriceInquiry(entities, context) {
    const responses = [
      "ุจุงููุณุจุฉ ููุฃุณุนุงุฑุ ุนูุฏูุง ุดุบูุงุช ุชุจุฏุฃ ูู 10$ ูุญุฏ 1000$ุ ุญุณุจ ุงููู ุจุฏู ุฅูุงู! ๐ฐ",
      "ุฃุณุนุงุฑูุง ูุงููู ููุงูุณุฉ! ูููุงู ูู ุนุฑูุถ ุญููุฉ ูุงููุชุฑุฉ ๐",
      "ุงูุฃุณุนุงุฑ ุนูุฏูุง ูุฑูุฉ ูููุงุณุจุฉ ููู ุงููุงุณุ ููู ุฎุตููุงุช ููุงู! ๐ธ"
    ];

    let response = this.getRandomElement(responses);
    
    if (context.hasDiscounts) {
      response += "\n\nูุจุตุฑุงุญุฉุ ูู ุฎุตููุงุช ุชุตู ูู 50% ุนูู ููุชุฌุงุช ูุฎุชุงุฑุฉ! ๐ฅ";
    }

    return response;
  }

  // ูุนุงูุฌุฉ ุงูุชูุตูุงุช
  handleRecommendation(context) {
    const responses = [
      "ุจูุงุกู ุนูู ุฐููู ุงูุญููุ ุฃูุตุญู ุชุดูู ูุฐู ุงูููุชุฌุงุช: ๐",
      "ุฃูุง ูุชุฃูุฏ ุฅูู ุฑุงุญ ุชุญุจ ูุฐูู! ุดูููู: ๐",
      "ุนูุฏู ุงูุชุฑุงุญุงุช ุฑููุจุฉ ูู! ุชุนุงู ุดูู: ๐ฏ"
    ];

    return this.getRandomElement(responses);
  }

  // ูุนุงูุฌุฉ ุงููุฏุงุน
  handleFarewell(context) {
    const farewells = [
      "ููุง ูุน ุงูุณูุงูุฉ! ูุงู ูู ุฏูุงุนู ุณุฑูุฑู ๐ ุงุณุชูุงู ูุฑูุจ!",
      "ุงููู ูุนู! ุฅู ุดุงุก ุงููู ุชููู ูููุช ุงููู ุจุฏู ุฅูุงู ๐",
      "ุจุงุงุงู! ููุฑุชูุง ูุงูููุ ุชุนุงู ุฒูุฑูุง ูู ูุง ุจุฏู! ๐",
      "ุชููู ุนูู ุงููู! ููุง ุชูุณุงูุงุด ูุง ๐"
    ];

    return this.getRandomElement(farewells);
  }

  // ูุนุงูุฌุฉ ุนุงูุฉ
  handleGeneral(context) {
    const responses = [
      "ุชูุงูุ ุฎูููู ุฃุณุงุนุฏู! ุฅูุด ุจุงูุถุจุท ุงููู ุจุชุฏูุฑ ุนูููุ ๐ค",
      "ุฃููุฏ! ุฃูุง ููุง ุนุดุงู ุฃุณุงุนุฏูุ ููู ูู ุฅูุด ุชุญุชุงุฌุ ๐",
      "ุทูุจุ ูููู ุชูุถุญ ูู ุฃูุซุฑ ุนุดุงู ุฃูุฏุฑ ุฃุณุงุนุฏู ุฃุญุณูุ ๐ญ"
    ];

    return this.getRandomElement(responses);
  }

  // ุฅุถุงูุฉ ููุณุฉ ุดุฎุตูุฉ
  addPersonalTouch() {
    const touches = [
      "\n\nูุจุงูููุงุณุจุฉุ ุฐููู ุญูู! ๐",
      "\n\nุฃูุง ููุง ูู ุงุญุชุฌุช ุฃู ูุณุงุนุฏุฉ ุซุงููุฉ! ๐",
      "\n\nููุง ุชูุณู ุชุดูู ุงูุนุฑูุถ ุงูุฌุฏูุฏุฉ! ๐",
      "\n\nูุง ุฑูุช ุชูุงูู ุงููู ูุนุฌุจู! ๐"
    ];

    return this.getRandomElement(touches);
  }

  // ุชุญุฏูุซ ุงูุฐุงูุฑุฉ
  updateMemory(intent, entities, sentiment) {
    this.conversationMemory.interactionCount++;
    
    if (entities.products.length > 0) {
      this.conversationMemory.searchHistory.push(...entities.products);
    }
    
    if (sentiment !== 'neutral') {
      this.conversationMemory.mood = sentiment;
    }
    
    // ุญูุธ ุงูุชูุถููุงุช
    if (entities.colors.length > 0 || entities.prices.length > 0) {
      this.conversationMemory.preferences.push({
        colors: entities.colors,
        priceRange: entities.prices
      });
    }
  }

  // ุฏุงูุฉ ูุณุงุนุฏุฉ ููุญุตูู ุนูู ุนูุตุฑ ุนุดูุงุฆู
  getRandomElement(array) {
    return array[Math.floor(Math.random() * array.length)];
  }

  // ุชุญุฏูุฏ ุงูููุฉ ูู ุงูุฑุณุงูุฉ
  detectIntent(message) {
    const lowerMessage = message.toLowerCase();
    
    // ูุญุต ูู ููุท
    for (const [category, data] of Object.entries(this.arabicPatterns)) {
      if (data.patterns) {
        for (const pattern of data.patterns) {
          if (pattern.test(lowerMessage)) {
            return category === 'greetings' ? 'greeting' :
                   category === 'productQueries' ? 'product_search' :
                   category === 'priceQueries' ? 'price_inquiry' :
                   category === 'farewell' ? 'farewell' : 'general';
          }
        }
      }
    }
    
    // ุฅุฐุง ูู ูุชุทุงุจู ุฃู ููุทุ ุญุงูู ุชุญุฏูุฏ ุงูููุฉ ูู ุงููููุงุช ุงูููุชุงุญูุฉ
    if (lowerMessage.includes('ุชูุตู') || lowerMessage.includes('ูุตูุญุฉ') || lowerMessage.includes('ุงูุชุฑุงุญ')) {
      return 'recommendation';
    }
    
    return 'general';
  }

  // ูุนุงูุฌุฉ ุงูุฑุณุงูุฉ ุงูุฑุฆูุณูุฉ
  processMessage(userMessage, context = {}) {
    // ุชุญุฏูุฏ ุงูููุฉ
    const intent = this.detectIntent(userMessage);
    
    // ุฅุถุงูุฉ ุงูุฑุณุงูุฉ ููุณูุงู
    context.userMessage = userMessage;
    context.isThinking = true;
    
    // ุชูููุฏ ุงูุฑุฏ ุงูุจุดุฑู
    const response = this.generateHumanResponse(intent, context);
    
    return {
      text: response,
      intent: intent,
      sentiment: this.analyzeSentiment(userMessage),
      entities: this.extractEntities(userMessage),
      suggestions: this.generateSuggestions(intent)
    };
  }

  // ุชูููุฏ ุงูุชุฑุงุญุงุช ูููุณุชุฎุฏู
  generateSuggestions(intent) {
    const suggestions = {
      greeting: ["ุฃุฑูุฏ ุฃู ุฃุฑู ุงูููุชุฌุงุช", "ูุง ูู ุงูุนุฑูุถ ุงููุชุงุญุฉุ", "ุฃุจุญุซ ุนู ูุงุชู"],
      product_search: ["ุฃุฑูุฏ ุฑุคูุฉ ุงููุฒูุฏ", "ูุง ูู ุงูุณุนุฑุ", "ูู ููุฌุฏ ุฎุตููุงุชุ"],
      price_inquiry: ["ุฃุฑูุฏ ุงูุฃุฑุฎุต", "ุฃุฑูุฏ ุงูุฃูุถู ุฌูุฏุฉ", "ูุง ูู ุทุฑู ุงูุฏูุนุ"],
      recommendation: ["ุฃุฑูุฏ ุฎูุงุฑุงุช ุฃุฎุฑู", "ูุง ุฑุฃูู ูู ูุฐุงุ", "ุฃูููุง ุฃูุถูุ"],
      farewell: ["ุดูุฑุงู ูู", "ุฅูู ุงูููุงุก", "ุณุฃุนูุฏ ูุงุญูุงู"],
      general: ["ุฃุฑูุฏ ุงููุณุงุนุฏุฉ", "ุฃุจุญุซ ุนู ููุชุฌ", "ูุง ูู ุงูุชุตูููุงุช ุงููุชุงุญุฉุ"]
    };

    return suggestions[intent] || suggestions.general;
  }
}

export default ArabicNLPEngine;
